<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HMS Warehouse - Telkom Office Mapper</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { box-sizing: border-box; }
        body { font-family: system-ui, -apple-system, sans-serif; }
        #map { height: 450px; width: 100%; border-radius: 0.5rem; }
        .leaflet-popup-content { font-size: 0.875rem; }
        .tab-active { border-bottom: 3px solid #4f46e5; color: #4f46e5; font-weight: 600; }
        .tab-inactive { color: #6b7280; }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-slate-100 min-h-screen p-4">
    <div id="app"></div>

    <script>
        // Google Sheets CSV URLs
        const SHEETS_CONFIG = {
            hmsWarehouse: 'YOUR_HMS_WAREHOUSE_CSV_URL',
            telkomOffice: 'YOUR_TELKOM_OFFICE_CSV_URL'
        };

        const hmsWarehouses = [
            { id: 1, zona: "NORTH SUMATRA ZONE", kota: "Medan 1", lat: 3.5930666653098062, lng: 98.63792100303282 },
            { id: 2, zona: "NORTH SUMATRA ZONE", kota: "Medan 2", lat: 3.5373546229355055, lng: 98.82088702562696 },
            { id: 3, zona: "NORTH SUMATRA ZONE", kota: "Banda Aceh", lat: 5.541530128067164, lng: 95.31082651905314 },
            { id: 4, zona: "NORTH SUMATRA ZONE", kota: "Lhokseumawe", lat: 5.186274068515949, lng: 97.12107949849023 },
            { id: 6, zona: "NORTH SUMATRA ZONE", kota: "DPC Meulaboh", lat: 4.168314296272862, lng: 96.13511157681005 },
            { id: 7, zona: "NORTH SUMATRA ZONE", kota: "DPC Rantau Prapat", lat: 2.1241432627615664, lng: 99.82472526594084 },
            { id: 8, zona: "NORTH SUMATRA ZONE", kota: "DPC Sibolga", lat: 1.7130951791071425, lng: 98.81596241012275 },
            { id: 9, zona: "NORTH SUMATRA ZONE", kota: "DPC Solok", lat: -0.8014631935328439, lng: 100.66385361013147 },
            { id: 10, zona: "NORTH SUMATRA ZONE", kota: "Tanah Karo", lat: 3.1197931650305533, lng: 98.50699229663111 },
            { id: 11, zona: "NORTH SUMATRA ZONE", kota: "Kisaran", lat: 3.012864286220907, lng: 99.6079364473068 },
            { id: 12, zona: "NORTH SUMATRA ZONE", kota: "Padang Sidempuan", lat: 1.3973450089321042, lng: 99.24865926408783 },
            { id: 13, zona: "NORTH SUMATRA ZONE", kota: "Pematang Siantar", lat: 2.9987885091636466, lng: 99.08262502361333 },
            { id: 14, zona: "NORTH SUMATRA ZONE", kota: "Padang", lat: -0.8627102743494186, lng: 100.3763405082778 },
            { id: 15, zona: "NORTH SUMATRA ZONE", kota: "Pekanbaru", lat: 0.48085738331435635, lng: 101.44134694452403 },
            { id: 16, zona: "NORTH SUMATRA ZONE", kota: "Air Molek", lat: -0.3659996694168614, lng: 102.29450862176635 },
            { id: 17, zona: "NORTH SUMATRA ZONE", kota: "Batam", lat: 1.1088463622616913, lng: 104.06757239477875 },
            { id: 18, zona: "NORTH SUMATRA ZONE", kota: "Bukittinggi", lat: -0.3250325836159367, lng: 100.38440672745276 },
            { id: 20, zona: "SOUTH SUMATRA ZONE", kota: "Palembang", lat: -2.9114864022312092, lng: 104.7146463352749 },
            { id: 21, zona: "SOUTH SUMATRA ZONE", kota: "DPC Baturaja", lat: -4.125175129210253, lng: 104.18698878477373 },
            { id: 22, zona: "SOUTH SUMATRA ZONE", kota: "Jambi", lat: -1.64338070757022, lng: 103.63053421199074 },
            { id: 23, zona: "SOUTH SUMATRA ZONE", kota: "Kayu Agung", lat: -3.4147796106215464, lng: 104.8238112561867 },
            { id: 24, zona: "SOUTH SUMATRA ZONE", kota: "Lahat", lat: -3.771726261540192, lng: 103.56825192083302 },
            { id: 25, zona: "SOUTH SUMATRA ZONE", kota: "Muara Bungo", lat: -1.534233973579583, lng: 102.10242746358735 },
            { id: 26, zona: "SOUTH SUMATRA ZONE", kota: "Pangkal Pinang", lat: -2.141622584413191, lng: 106.10032905988368 },
            { id: 29, zona: "SOUTH SUMATRA ZONE", kota: "Bengkulu", lat: -3.7680956, lng: 102.2705372 },
            { id: 30, zona: "SOUTH SUMATRA ZONE", kota: "DPC Lubuk Linggau", lat: -3.3010334, lng: 102.8830381 },
            { id: 31, zona: "SOUTH SUMATRA ZONE", kota: "DPC Pringsewu", lat: -5.356726399999999, lng: 104.9473194 },
            { id: 32, zona: "SOUTH SUMATRA ZONE", kota: "DPC Tulang Bawang", lat: -4.299966929807776, lng: 105.21927347947022 },
            { id: 33, zona: "SOUTH SUMATRA ZONE", kota: "Kotabumi", lat: -4.8403991, lng: 104.892966 },
            { id: 34, zona: "SOUTH SUMATRA ZONE", kota: "Metro", lat: -5.0977077, lng: 105.3384084 },
            { id: 35, zona: "JAKARTA ZONE", kota: "Jakarta Barat - Kebon Jeruk", lat: -6.19229453919793, lng: 106.76848176600298 },
            { id: 36, zona: "JAKARTA ZONE", kota: "Jakarta Utara", lat: -6.12941730885776, lng: 106.91052718268799 },
            { id: 37, zona: "JAKARTA ZONE", kota: "Depok", lat: -6.380075295417604, lng: 106.84158802367818 },
            { id: 38, zona: "JAKARTA ZONE", kota: "Jakarta Pusat - Kemayoran", lat: -6.161620656732017, lng: 106.84504455065742 },
            { id: 39, zona: "JAKARTA ZONE", kota: "Jakarta Timur", lat: -6.19942267020731, lng: 106.90522792923758 },
            { id: 40, zona: "JAKARTA ZONE", kota: "Jakarta Selatan - Pasar Minggu", lat: -6.2714243766749975, lng: 106.84732513109259 },
            { id: 41, zona: "JAKARTA ZONE", kota: "Bogor", lat: -6.5118715980113855, lng: 106.8532864291344 },
            { id: 42, zona: "JAKARTA ZONE", kota: "DPC Ciampea", lat: -6.555939802554793, lng: 106.6959435482959 },
            { id: 43, zona: "JAKARTA ZONE", kota: "Bekasi", lat: -6.259874430764165, lng: 107.04957699129737 },
            { id: 44, zona: "JAKARTA ZONE", kota: "Tangerang Satelit - Cikupa", lat: -6.213383822099827, lng: 106.48929130225545 },
            { id: 45, zona: "JAKARTA ZONE", kota: "Tangerang Cikokol", lat: -6.2033738582985585, lng: 106.62731753693129 },
            { id: 46, zona: "JAKARTA ZONE", kota: "Pondok Pinang", lat: -6.27490361535198, lng: 106.77061697185248 },
            { id: 47, zona: "JAKARTA ZONE", kota: "Karawang", lat: -6.2706737094786815, lng: 107.3626507866126 },
            { id: 48, zona: "JAKARTA ZONE", kota: "Rangkasbitung", lat: -6.342680167241045, lng: 106.2461643557088 },
            { id: 49, zona: "JAKARTA ZONE", kota: "Serang", lat: -6.119352733652986, lng: 106.19667529803301 },
            { id: 50, zona: "WEST JAVA ZONE", kota: "Bandung", lat: -6.933844289393681, lng: 107.68946567157579 },
            { id: 51, zona: "WEST JAVA ZONE", kota: "Cirebon", lat: -6.706023, lng: 108.537502 },
            { id: 52, zona: "WEST JAVA ZONE", kota: "Cianjur", lat: -6.857387999999999, lng: 107.1091739 },
            { id: 53, zona: "WEST JAVA ZONE", kota: "Indramayu", lat: -6.3741646, lng: 108.2956318 },
            { id: 54, zona: "WEST JAVA ZONE", kota: "Sumedang", lat: -6.8464456, lng: 107.9399576 },
            { id: 55, zona: "WEST JAVA ZONE", kota: "Garut", lat: -7.206228299999999, lng: 107.9151826 },
            { id: 56, zona: "WEST JAVA ZONE", kota: "Subang", lat: -6.548620300000001, lng: 107.776159 },
            { id: 57, zona: "WEST JAVA ZONE", kota: "Sukabumi", lat: -6.9213885, lng: 106.9584409 },
            { id: 58, zona: "WEST JAVA ZONE", kota: "Tasikmalaya", lat: -7.341192899999999, lng: 108.1960066 },
            { id: 59, zona: "CENTRAL JAVA ZONE", kota: "Yogyakarta", lat: -7.713535631526459, lng: 110.36752285098801 },
            { id: 60, zona: "CENTRAL JAVA ZONE", kota: "DPC Cilacap", lat: -7.698939599999999, lng: 109.0283507 },
            { id: 61, zona: "CENTRAL JAVA ZONE", kota: "DPC Pekalongan", lat: -6.8900849, lng: 109.6456336 },
            { id: 62, zona: "CENTRAL JAVA ZONE", kota: "Magelang", lat: -7.500645500000001, lng: 110.2255931 },
            { id: 63, zona: "CENTRAL JAVA ZONE", kota: "Purwokerto", lat: -7.437790000000001, lng: 109.2588957 },
            { id: 64, zona: "CENTRAL JAVA ZONE", kota: "Solo", lat: -7.582639622082262, lng: 110.78402666417007 },
            { id: 65, zona: "CENTRAL JAVA ZONE", kota: "Tegal", lat: -7.0939361, lng: 108.9862277 },
            { id: 66, zona: "CENTRAL JAVA ZONE", kota: "Semarang", lat: -7.00453, lng: 110.4545628 },
            { id: 67, zona: "CENTRAL JAVA ZONE", kota: "Kediri", lat: -7.8451614, lng: 112.0277915 },
            { id: 68, zona: "CENTRAL JAVA ZONE", kota: "Madiun", lat: -7.598280099999999, lng: 111.5362137 },
            { id: 69, zona: "CENTRAL JAVA ZONE", kota: "Pati", lat: -6.7310678, lng: 111.0490169 },
            { id: 70, zona: "CENTRAL JAVA ZONE", kota: "Tuban", lat: -6.8684278, lng: 112.034007 },
            { id: 71, zona: "EAST JAVA ZONE", kota: "Sidoarjo Berbek", lat: -7.349053624625632, lng: 112.75766733833791 },
            { id: 72, zona: "EAST JAVA ZONE", kota: "Malang", lat: -7.9526973, lng: 112.6392338 },
            { id: 73, zona: "EAST JAVA ZONE", kota: "Pamekasan", lat: -7.145264900000001, lng: 113.5143264 },
            { id: 74, zona: "EAST JAVA ZONE", kota: "Probolinggo", lat: -7.758238, lng: 113.4334453 },
            { id: 75, zona: "EAST JAVA ZONE", kota: "DPC Banyuwangi", lat: -8.297233, lng: 114.306485 },
            { id: 77, zona: "EAST JAVA ZONE", kota: "Jember", lat: -8.213365, lng: 113.7151397 },
            { id: 79, zona: "EAST JAVA ZONE", kota: "Denpasar", lat: -8.7179804, lng: 115.2017273 },
            { id: 86, zona: "EAST INDONESIA ZONE", kota: "Bone", lat: -4.5156705, lng: 120.2750429 },
            { id: 87, zona: "EAST INDONESIA ZONE", kota: "DPC Palopo", lat: -3.0176139, lng: 120.2079767 },
            { id: 88, zona: "EAST INDONESIA ZONE", kota: "Gorontalo", lat: 0.5685222, lng: 123.0657331 },
            { id: 89, zona: "EAST INDONESIA ZONE", kota: "Kendari", lat: -3.9723225, lng: 122.5155315 },
            { id: 90, zona: "EAST INDONESIA ZONE", kota: "Manado", lat: 1.4830196, lng: 124.8557027 },
            { id: 91, zona: "EAST INDONESIA ZONE", kota: "Palu", lat: -0.8201563, lng: 119.8861834 },
            { id: 93, zona: "EAST INDONESIA ZONE", kota: "Balikpapan", lat: -1.2458075, lng: 116.8714767 },
            { id: 94, zona: "EAST INDONESIA ZONE", kota: "Banjarmasin", lat: -3.378102351246243, lng: 114.64788205581854 },
            { id: 95, zona: "EAST INDONESIA ZONE", kota: "Berau", lat: 2.1551942, lng: 117.4993127 },
            { id: 96, zona: "EAST INDONESIA ZONE", kota: "DPC Barabai", lat: -2.5941807, lng: 115.3686793 },
            { id: 97, zona: "EAST INDONESIA ZONE", kota: "DPC Sangatta", lat: 0.4966067, lng: 117.5304771 },
            { id: 98, zona: "EAST INDONESIA ZONE", kota: "Palangkaraya", lat: -2.222940886676254, lng: 113.92472552698229 },
            { id: 99, zona: "EAST INDONESIA ZONE", kota: "Pontianak", lat: -0.0548688, lng: 109.3424906 },
            { id: 100, zona: "EAST INDONESIA ZONE", kota: "Samarinda", lat: -0.471937, lng: 117.125736 },
            { id: 101, zona: "EAST INDONESIA ZONE", kota: "Sintang", lat: 0.0177428, lng: 111.4557429 },
            { id: 102, zona: "EAST INDONESIA ZONE", kota: "Ambon", lat: -3.6951336, lng: 128.1854798 },
            { id: 103, zona: "EAST INDONESIA ZONE", kota: "Jayapura", lat: -2.5696665, lng: 140.7052456 },
            { id: 104, zona: "EAST INDONESIA ZONE", kota: "Sorong", lat: -0.8863998999999999, lng: 131.2949403 },
            { id: 105, zona: "EAST INDONESIA ZONE", kota: "Ternate", lat: 0.7720036, lng: 127.3681045 }
        ];

        // Data Telkom Offices
        const telkomOffices = [
            { id: 1, kota: "Banda Aceh Kota", nama: "Plasa Telkom Banda Aceh", lat: 5.556852, lng: 95.32355 },
            { id: 2, kota: "Aceh Tamiang", nama: "Plasa Telkom Kuala Simpang", lat: 4.283436, lng: 98.05798 },
            { id: 3, kota: "Aceh Barat Daya", nama: "Plasa Telkom Bilang Pidie", lat: 3.739839, lng: 96.83916 },
            { id: 4, kota: "Langkat", nama: "Plasa Telkom Pangkalan Brandan", lat: 4.020468, lng: 98.28706 },
            { id: 5, kota: "Kabanjahe", nama: "Plasa Telkom Kabanjahe", lat: 3.102468, lng: 98.49695 },
            { id: 6, kota: "Bangka belitung", nama: "Plasa Telkom Sungai Liat", lat: -1.86313, lng: 106.1067 },
            { id: 7, kota: "Jambi", nama: "Plasa Telkom Bangko", lat: -2.06448, lng: 102.2753 },
            { id: 8, kota: "Riau", nama: "Plasa Telkom Bengkalis", lat: 1.466252, lng: 102.1108 },
            { id: 9, kota: "Tebing Tinggi", nama: "Plasa Telkom Tebing Tinggi", lat: 3.335392, lng: 99.17076 },
            { id: 10, kota: "Lampung", nama: "Plasa Telkom Metro", lat: -5.11324, lng: 105.3111 },
            { id: 11, kota: "Jambi", nama: "Plasa Telkom Jambi", lat: -1.6100780928859, lng: 103.59635848209 },
            { id: 12, kota: "Langkat", nama: "Plasa Telkom Stabat", lat: 3.742687, lng: 98.444011 },
            { id: 13, kota: "Sibolga", nama: "Plasa Telkom Sibolga", lat: 1.740911, lng: 98.776458 },
            { id: 14, kota: "Tanjung Balai", nama: "Plasa Telkom Tanjung Balai", lat: 2.964483, lng: 99.806039 },
            { id: 17, kota: "Serang", nama: "Plasa Telkom Serang", lat: -6.112922, lng: 106.141644 },
            { id: 18, kota: "Bogor", nama: "Plasa Telkom Pajajaran", lat: -6.187019, lng: 107.048929 },
            { id: 22, kota: "Sukabumi", nama: "Plasa Telkom Sukabumi", lat: -6.920675, lng: 106.925100 },
            { id: 23, kota: "Tasikmalaya", nama: "Plasa Telkom Tasikmalaya", lat: -7.323565, lng: 108.225168 },
            { id: 24, kota: "Garut", nama: "Plasa Telkom Garut", lat: -7.216481, lng: 107.904589 },
            { id: 25, kota: "Indramayu", nama: "Plasa Telkom Indramayu", lat: -6.341484, lng: 108.337440 },
            { id: 26, kota: "Temanggung", nama: "Plasa Telkom Temanggung", lat: -7.321021, lng: 110.187970 },
            { id: 27, kota: "Muntilan", nama: "Plasa Telkom Muntilan", lat: -7.583631, lng: 110.288694 },
            { id: 28, kota: "Kudus", nama: "Plasa Telkom Kudus", lat: -6.80711, lng: 110.8462 },
            { id: 29, kota: "Banyumas", nama: "Plasa Telkom Purwokerto MEA", lat: -7.42458, lng: 109.2375 },
            { id: 30, kota: "Tegal", nama: "Plasa Telkom Tegal", lat: -6.86469, lng: 109.1341 },
            { id: 31, kota: "Semarang", nama: "Plasa Telkom Digital Pahlawan", lat: -6.99428, lng: 110.4217 },
            { id: 32, kota: "Salatiga", nama: "Plasa Telkom Salatiga", lat: -7.32484, lng: 110.5032 },
            { id: 34, kota: "Sumbawa", nama: "Plasa Telkom Sumbawa", lat: -8.49783, lng: 117.4258 },
            { id: 35, kota: "Surabaya", nama: "Plasa Telkom Mergoyoso", lat: -7.26251, lng: 112.7399 },
            { id: 36, kota: "Mojokerto", nama: "Plasa Telkom Mojokerto", lat: -7.46419, lng: 112.4348 },
            { id: 37, kota: "Bondowoso", nama: "Plasa Telkom Bondowoso", lat: -7.92233, lng: 113.8184 },
            { id: 38, kota: "Jember", nama: "Plasa Telkom Jember", lat: -8.174119, lng: 113.685661 },
            { id: 39, kota: "Probolinggo", nama: "Plasa Telkom Probolinggo", lat: -7.74506, lng: 113.2151 },
            { id: 40, kota: "Trenggalek", nama: "Plasa Telkom Trenggalek", lat: -8.048013, lng: 111.709492 },
            { id: 41, kota: "Banyuwangi", nama: "Plasa Telkom Kandangan", lat: -8.212842, lng: 114.374981 },
            { id: 42, kota: "Tuban", nama: "Plasa Telkom Tuban", lat: -6.894517, lng: 112.067494 },
            { id: 43, kota: "Pasuruan", nama: "Plasa Telkom Pandaan", lat: -7.648753, lng: 112.688453 },
            { id: 44, kota: "Bojonegoro", nama: "Plasa Telkom Bojonegoro", lat: -7.152450, lng: 111.881744 },
            { id: 45, kota: "Tabanan", nama: "Plasa Telkom Tabanan", lat: -8.541658, lng: 115.122400 },
            { id: 47, kota: "Palangka Raya", nama: "Plasa Telkom Palangka Raya", lat: -2.208781, lng: 113.930142 },
            { id: 48, kota: "Kandangan", nama: "Plasa Telkom Kandangan", lat: -2.782675, lng: 115.262989 },
            { id: 49, kota: "Makassar", nama: "Plasa Telkom Pettarani", lat: -2.995575, lng: 120.195864 },
            { id: 50, kota: "Palopo", nama: "Plasa Telkom Palopo", lat: -5.172769, lng: 119.432886 },
            { id: 51, kota: "Maluku", nama: "Plasa Telkom Masohi", lat: -3.303950, lng: 128.952897 },
            { id: 52, kota: "Maluku", nama: "Plasa Telkom Nabire", lat: -3.36483, lng: 135.503189 },
            { id: 53, kota: "Biak Numfor", nama: "Plasa Telkom Biak Numfor", lat: -1.186731, lng: 136.090550 },
            { id: 54, kota: "Ambon", nama: "Plasa Telkom Ambon", lat: -3.702843, lng: 128.173715 },
            { id: 55, kota: "Merauke", nama: "Plasa Telkom Merauke", lat: -8.506531, lng: 140.408564 },
            { id: 56, kota: "Maluku", nama: "Plasa Telkom Tual", lat: -7.984028, lng: 131.298064 },
            { id: 57, kota: "Jayawijaya", nama: "Plasa Telkom Jayawijaya", lat: -4.095196, lng: 138.942276 },
            { id: 58, kota: "Jayapura", nama: "Plasa Telkom Sentani", lat: -2.566546, lng: 140.512192 }
        ];

        // Calculate distance
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Find nearest Telkom office
        function findNearestTelkom(warehouse) {
            let nearest = null;
            let minDistance = Infinity;
            telkomOffices.forEach(telkom => {
                const distance = calculateDistance(warehouse.lat, warehouse.lng, telkom.lat, telkom.lng);
                if (distance < minDistance) {
                    minDistance = distance;
                    nearest = { ...telkom, distance };
                }
            });
            return nearest;
        }

        // Generate all mappings
        function getAllMappings() {
            return hmsWarehouses.map(warehouse => ({
                warehouse,
                nearestTelkom: findNearestTelkom(warehouse)
            }));
        }

        // Export to CSV
        function exportToCSV() {
            const allMappings = getAllMappings();
            const headers = ['No','HMS WAREHOUSE','ZONA HMS','LATITUDE HMS','LONGITUDE HMS','OFFICE TELKOM TERDEKAT','KOTA TELKOM','LATITUDE TELKOM','LONGITUDE TELKOM','JARAK (KM)','STATUS'].join(',');
            const rows = allMappings.map((mapping, idx) => {
                const status = mapping.nearestTelkom.distance <= 20 ? 'Sesuai Kriteria (≤20km)' : 'Lebih dari 20km';
                return [idx + 1, `"${mapping.warehouse.kota}"`, `"${mapping.warehouse.zona}"`, mapping.warehouse.lat.toFixed(6), mapping.warehouse.lng.toFixed(6), `"${mapping.nearestTelkom.nama}"`, `"${mapping.nearestTelkom.kota}"`, mapping.nearestTelkom.lat.toFixed(6), mapping.nearestTelkom.lng.toFixed(6), mapping.nearestTelkom.distance.toFixed(2), `"${status}"`].join(',');
            });
            const under20 = allMappings.filter(m => m.nearestTelkom.distance <= 20).length;
            const over20 = allMappings.filter(m => m.nearestTelkom.distance > 20).length;
            const summary = ['','','RINGKASAN DATA',`Total HMS Warehouse: ${allMappings.length}`,`Jarak ≤ 20 km: ${under20} lokasi`,`Jarak > 20 km: ${over20} lokasi`,`Tanggal Export: ${new Date().toLocaleDateString('id-ID')}`].join('\n');
            const csv = [headers, ...rows, summary].join('\n');
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + csv], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `HMS-Telkom-Mapping-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // State management
        let selectedWarehouse = null;
        let filterZone = 'ALL';
        let currentTab = 'map'; // 'map' or 'table'
        let map = null;
        let markers = { hms: null, telkom: null };
        let routeLine = null;

        function getZones() {
            return ['ALL', ...new Set(hmsWarehouses.map(w => w.zona))];
        }

        // Initialize or update map
        function initMap(warehouse, telkom) {
            // Destroy existing map if any
            if (map) {
                map.remove();
                map = null;
            }

            // Create new map
            setTimeout(() => {
                map = L.map('map').setView([warehouse.lat, warehouse.lng], 10);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors'
                }).addTo(map);

                // Custom icons
                const hmsIcon = L.divIcon({
                    className: 'custom-icon',
                    html: '<div style="background-color: #dc2626; color: white; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; border: 3px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3);"><i class="fas fa-warehouse"></i></div>',
                    iconSize: [36, 36],
                    iconAnchor: [18, 18]
                });

                const telkomIcon = L.divIcon({
                    className: 'custom-icon',
                    html: '<div style="background-color: #2563eb; color: white; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; border: 3px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3);"><i class="fas fa-building"></i></div>',
                    iconSize: [36, 36],
                    iconAnchor: [18, 18]
                });

                // Add markers
                L.marker([warehouse.lat, warehouse.lng], { icon: hmsIcon })
                    .bindPopup(`<strong>HMS Warehouse</strong><br>${warehouse.kota}<br><small>${warehouse.zona}</small>`)
                    .addTo(map);

                L.marker([telkom.lat, telkom.lng], { icon: telkomIcon })
                    .bindPopup(`<strong>Telkom Office</strong><br>${telkom.nama}<br><small>${telkom.kota}</small>`)
                    .addTo(map);

                // Add route line
                const lineColor = telkom.distance <= 20 ? '#10b981' : '#f59e0b';
                L.polyline([[warehouse.lat, warehouse.lng], [telkom.lat, telkom.lng]], {
                    color: lineColor,
                    weight: 3,
                    opacity: 0.7,
                    dashArray: '10, 10'
                }).addTo(map);

                // Fit bounds
                const bounds = L.latLngBounds([[warehouse.lat, warehouse.lng], [telkom.lat, telkom.lng]]);
                map.fitBounds(bounds, { padding: [50, 50] });
            }, 100);
        }

        // Render app
        function render() {
            const allMappings = getAllMappings();
            const zones = getZones();
            const filteredWarehouses = filterZone === 'ALL' ? hmsWarehouses : hmsWarehouses.filter(w => w.zona === filterZone);
            const filteredMappings = filterZone === 'ALL' ? allMappings : allMappings.filter(m => m.warehouse.zona === filterZone);
            const under20km = allMappings.filter(m => m.nearestTelkom.distance <= 20).length;
            const over20km = allMappings.filter(m => m.nearestTelkom.distance > 20).length;
            const nearestTelkom = selectedWarehouse ? findNearestTelkom(selectedWarehouse) : null;

            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="max-w-7xl mx-auto">
                    <!-- Header -->
                    <div class="bg-white rounded-xl shadow-md p-6 mb-6">
                        <div class="flex items-center gap-3 mb-2">
                            <i class="fas fa-map-marked-alt text-3xl text-indigo-600"></i>
                            <h1 class="text-3xl font-bold text-gray-800">HMS Warehouse - Telkom Office Mapper</h1>
                        </div>
                        <p class="text-gray-600">Analisis jarak antara gudang HMS dengan kantor Telkom terdekat</p>
                        
                        <!-- Statistics -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
                            <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-lg border border-blue-200">
                                <div class="flex items-center gap-3">
                                    <i class="fas fa-warehouse text-2xl text-blue-600"></i>
                                    <div>
                                        <div class="text-2xl font-bold text-blue-700">${hmsWarehouses.length}</div>
                                        <div class="text-sm text-gray-700">Total HMS Warehouse</div>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-gradient-to-br from-green-50 to-green-100 p-4 rounded-lg border border-green-200">
                                <div class="flex items-center gap-3">
                                    <i class="fas fa-check-circle text-2xl text-green-600"></i>
                                    <div>
                                        <div class="text-2xl font-bold text-green-700">${under20km}</div>
                                        <div class="text-sm text-gray-700">Jarak ≤ 20 km</div>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-gradient-to-br from-orange-50 to-orange-100 p-4 rounded-lg border border-orange-200">
                                <div class="flex items-center gap-3">
                                    <i class="fas fa-exclamation-triangle text-2xl text-orange-600"></i>
                                    <div>
                                        <div class="text-2xl font-bold text-orange-700">${over20km}</div>
                                        <div class="text-sm text-gray-700">Jarak > 20 km</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Controls -->
                    <div class="bg-white rounded-xl shadow-md p-4 mb-6">
                        <div class="flex flex-wrap gap-4 items-center justify-between">
                            <div class="flex items-center gap-3">
                                <label class="text-sm font-semibold text-gray-700 flex items-center gap-2">
                                    <i class="fas fa-filter text-indigo-600"></i>
                                    Filter Zona:
                                </label>
                                <select id="zoneFilter" class="border border-gray-300 rounded-lg px-4 py-2 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                    ${zones.map(zone => `<option value="${zone}" ${filterZone === zone ? 'selected' : ''}>${zone}</option>`).join('')}
                                </select>
                            </div>
                            
                            <button onclick="exportToCSV()" class="flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition shadow-sm">
                                <i class="fas fa-download"></i>
                                Export CSV
                            </button>
                        </div>
                    </div>

                    <!-- Tab Navigation -->
                    <div class="bg-white rounded-xl shadow-md mb-6">
                        <div class="flex border-b border-gray-200">
                            <button onclick="switchTab('map')" class="flex-1 px-6 py-4 text-center transition ${currentTab === 'map' ? 'tab-active' : 'tab-inactive hover:text-indigo-500'}">
                                <i class="fas fa-map mr-2"></i>
                                Peta Pemetaan
                            </button>
                            <button onclick="switchTab('table')" class="flex-1 px-6 py-4 text-center transition ${currentTab === 'table' ? 'tab-active' : 'tab-inactive hover:text-indigo-500'}">
                                <i class="fas fa-table mr-2"></i>
                                Tabel Data Lengkap
                            </button>
                        </div>
                    </div>

                    ${currentTab === 'map' ? `
                    <!-- Map View -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Warehouse List -->
                        <div class="lg:col-span-1 bg-white rounded-xl shadow-md p-4 max-h-[700px] overflow-y-auto">
                            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                                <i class="fas fa-warehouse text-red-600"></i>
                                HMS Warehouses (${filteredWarehouses.length})
                            </h2>
                            <div class="space-y-2">
                                ${filteredWarehouses.map(warehouse => {
                                    const nearest = findNearestTelkom(warehouse);
                                    const isNear = nearest.distance <= 20;
                                    return `
                                    <button onclick="selectWarehouse(${warehouse.id})" class="w-full text-left p-3 rounded-lg border-2 transition ${selectedWarehouse?.id === warehouse.id ? 'border-indigo-500 bg-indigo-50 shadow-md' : 'border-gray-200 hover:border-indigo-300 hover:bg-gray-50'}">
                                        <div class="flex justify-between items-start">
                                            <div class="flex-1">
                                                <div class="font-semibold text-gray-800">${warehouse.kota}</div>
                                                <div class="text-xs text-gray-500 mt-1">${warehouse.zona}</div>
                                            </div>
                                            <span class="text-xs px-2 py-1 rounded ${isNear ? 'bg-green-100 text-green-700' : 'bg-orange-100 text-orange-700'}">
                                                ${nearest.distance.toFixed(1)} km
                                            </span>
                                        </div>
                                    </button>
                                `}).join('')}
                            </div>
                        </div>

                        <!-- Details Panel -->
                        <div class="lg:col-span-2">
                            ${selectedWarehouse && nearestTelkom ? `
                                <div class="bg-white rounded-xl shadow-md p-6">
                                    <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                                        <i class="fas fa-route text-indigo-600"></i>
                                        Detail Pemetaan
                                    </h2>
                                    
                                    <!-- Info Cards - Horizontal -->
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
                                        <!-- HMS Info -->
                                        <div class="bg-gradient-to-br from-red-50 to-red-100 p-4 rounded-lg border border-red-200">
                                            <div class="text-center">
                                                <i class="fas fa-warehouse text-3xl text-red-600 mb-2"></i>
                                                <h3 class="font-bold text-sm text-gray-800 mb-1">HMS Warehouse</h3>
                                                <p class="text-gray-800 font-semibold text-sm">${selectedWarehouse.kota}</p>
                                                <p class="text-xs text-gray-600 mt-1">${selectedWarehouse.zona}</p>
                                                <p class="text-xs text-gray-500 mt-2">
                                                    <i class="fas fa-map-pin"></i> ${selectedWarehouse.lat.toFixed(4)}, ${selectedWarehouse.lng.toFixed(4)}
                                                </p>
                                            </div>
                                        </div>

                                        <!-- Distance Badge -->
                                        <div class="flex items-center justify-center p-4 rounded-lg ${nearestTelkom.distance <= 20 ? 'bg-gradient-to-br from-green-50 to-green-100 border border-green-300' : 'bg-gradient-to-br from-orange-50 to-orange-100 border border-orange-300'}">
                                            <div class="text-center">
                                                <i class="fas fa-ruler text-2xl ${nearestTelkom.distance <= 20 ? 'text-green-700' : 'text-orange-700'} mb-2"></i>
                                                <div class="text-3xl font-bold ${nearestTelkom.distance <= 20 ? 'text-green-700' : 'text-orange-700'}">
                                                    ${nearestTelkom.distance.toFixed(2)} km
                                                </div>
                                                <div class="text-xs font-semibold ${nearestTelkom.distance <= 20 ? 'text-green-800' : 'text-orange-800'} mt-1">
                                                    ${nearestTelkom.distance <= 20 ? 'Sesuai Kriteria' : 'Melebihi Batas'}
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Telkom Info -->
                                        <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-lg border border-blue-200">
                                            <div class="text-center">
                                                <i class="fas fa-building text-3xl text-blue-600 mb-2"></i>
                                                <h3 class="font-bold text-sm text-gray-800 mb-1">Telkom Office</h3>
                                                <p class="text-gray-800 font-semibold text-sm">${nearestTelkom.nama}</p>
                                                <p class="text-xs text-gray-600 mt-1">${nearestTelkom.kota}</p>
                                                <p class="text-xs text-gray-500 mt-2">
                                                    <i class="fas fa-map-pin"></i> ${nearestTelkom.lat.toFixed(4)}, ${nearestTelkom.lng.toFixed(4)}
                                                </p>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Map -->
                                    <div id="map" class="mb-4"></div>

                                    <!-- Google Maps Link -->
                                    <a href="https://www.google.com/maps/dir/${selectedWarehouse.lat},${selectedWarehouse.lng}/${nearestTelkom.lat},${nearestTelkom.lng}" target="_blank" class="flex items-center justify-center gap-2 w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition font-semibold shadow-md">
                                        <i class="fas fa-directions"></i>
                                        Lihat Rute di Google Maps
                                    </a>
                                </div>
                            ` : `
                                <div class="bg-white rounded-xl shadow-md p-12 text-center">
                                    <i class="fas fa-mouse-pointer text-6xl text-gray-300 mb-4"></i>
                                    <h3 class="text-xl font-semibold text-gray-600 mb-2">Pilih Warehouse HMS</h3>
                                    <p class="text-gray-500">Pilih salah satu warehouse dari daftar di sebelah kiri untuk melihat peta dan informasi kantor Telkom terdekat</p>
                                </div>
                            `}
                        </div>
                    </div>
                    ` : `
                    <!-- Table View -->
                    <div class="bg-white rounded-xl shadow-md p-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                            <i class="fas fa-table text-indigo-600"></i>
                            Semua Data Pemetaan (${filteredMappings.length})
                        </h2>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-100 border-b-2 border-gray-200">
                                    <tr>
                                        <th class="px-4 py-3 text-left font-semibold text-gray-700">No</th>
                                        <th class="px-4 py-3 text-left font-semibold text-gray-700">HMS Warehouse</th>
                                        <th class="px-4 py-3 text-left font-semibold text-gray-700">Zona</th>
                                        <th class="px-4 py-3 text-left font-semibold text-gray-700">Telkom Office</th>
                                        <th class="px-4 py-3 text-left font-semibold text-gray-700">Kota Telkom</th>
                                        <th class="px-4 py-3 text-right font-semibold text-gray-700">Jarak (km)</th>
                                        <th class="px-4 py-3 text-center font-semibold text-gray-700">Status</th>
                                        <th class="px-4 py-3 text-center font-semibold text-gray-700">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    ${filteredMappings.map((mapping, idx) => `
                                        <tr class="hover:bg-gray-50 transition">
                                            <td class="px-4 py-3 text-gray-600">${idx + 1}</td>
                                            <td class="px-4 py-3 font-medium text-gray-800">${mapping.warehouse.kota}</td>
                                            <td class="px-4 py-3 text-gray-600 text-xs">${mapping.warehouse.zona}</td>
                                            <td class="px-4 py-3 text-gray-700">${mapping.nearestTelkom.nama}</td>
                                            <td class="px-4 py-3 text-gray-600">${mapping.nearestTelkom.kota}</td>
                                            <td class="px-4 py-3 text-right font-semibold text-gray-800">
                                                ${mapping.nearestTelkom.distance.toFixed(2)}
                                            </td>
                                            <td class="px-4 py-3 text-center">
                                                <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-semibold ${
                                                    mapping.nearestTelkom.distance <= 20
                                                        ? 'bg-green-100 text-green-700'
                                                        : 'bg-orange-100 text-orange-700'
                                                }">
                                                    <i class="fas fa-${mapping.nearestTelkom.distance <= 20 ? 'check' : 'exclamation-triangle'}"></i>
                                                    ${mapping.nearestTelkom.distance <= 20 ? '≤ 20km' : '> 20km'}
                                                </span>
                                            </td>
                                            <td class="px-4 py-3 text-center">
                                                <button onclick="viewOnMap(${mapping.warehouse.id})" class="text-indigo-600 hover:text-indigo-800 transition">
                                                    <i class="fas fa-map-marked-alt"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    `}

                    <!-- Footer Info -->
                    <div class="mt-6 bg-white rounded-xl shadow-md p-4">
                        <div class="flex items-center gap-2 text-sm text-gray-600">
                            <i class="fas fa-info-circle text-indigo-600"></i>
                            <span>Data diambil dari Google Sheets dan diperbarui secara real-time</span>
                        </div>
                    </div>
                </div>
            `;

            // Add event listener for zone filter
            const zoneFilter = document.getElementById('zoneFilter');
            if (zoneFilter) {
                zoneFilter.addEventListener('change', (e) => {
                    filterZone = e.target.value;
                    render();
                });
            }

            // Initialize map if warehouse is selected and on map tab
            if (selectedWarehouse && nearestTelkom && currentTab === 'map') {
                initMap(selectedWarehouse, nearestTelkom);
            }
        }

        // Event handlers
        window.selectWarehouse = function(id) {
            selectedWarehouse = hmsWarehouses.find(w => w.id === id);
            render();
        };

        window.switchTab = function(tab) {
            currentTab = tab;
            render();
        };

        window.viewOnMap = function(id) {
            selectedWarehouse = hmsWarehouses.find(w => w.id === id);
            currentTab = 'map';
            render();
        };

        window.exportToCSV = exportToCSV;

        // Initial render
        render();
    </script>
</body>
</html>

