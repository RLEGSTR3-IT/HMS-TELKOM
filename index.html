<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HMS Warehouse - Telkom Office Mapper</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        * { box-sizing: border-box; }
        body { font-family: system-ui, -apple-system, sans-serif; }
        #map { height: 450px; width: 100%; border-radius: 0.5rem; }
        .leaflet-popup-content { font-size: 0.875rem; }
        .tab-active { border-bottom: 3px solid #4f46e5; color: #4f46e5; font-weight: 600; }
        .tab-inactive { color: #6b7280; }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-slate-100 min-h-screen p-4">
    <div id="app"></div>

    <script>
        // Google Sheets CSV URLs
        const SHEETS_CONFIG = {
            hmsWarehouse: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQFW0PDOixi7Jlhcd629VlQARE3mrSJqRKa0OvjnxUp6vVU8HDrmggt7FjybTKidiFRYG5KBk_R27x1/pub?gid=1128681242&single=true&output=csv',
            telkomOffice: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTETvKfVJotQtjK7lFp5j6cYzLxumpBqPsPcEj_nP7bLvkSjGpfIQXmAHL66Zb7YmXuxyIwSNcfw5jA/pub?gid=0&single=true&output=csv'
        };

        // Data HMS Warehouses (akan diisi dari Google Sheets)
        let hmsWarehouses = [];

        // Data Telkom Offices (akan diisi dari Google Sheets)
        let telkomOffices = [];

        // Function to load data from Google Sheets
        async function loadDataFromSheets() {
            try {
                // Load HMS Warehouse data
                const hmsResponse = await fetch(SHEETS_CONFIG.hmsWarehouse);
                const hmsText = await hmsResponse.text();
                const hmsParsed = Papa.parse(hmsText, { 
                    header: true, 
                    skipEmptyLines: true,
                    dynamicTyping: true
                });
                
                // Load Telkom Office data
                const telkomResponse = await fetch(SHEETS_CONFIG.telkomOffice);
                const telkomText = await telkomResponse.text();
                const telkomParsed = Papa.parse(telkomText, { 
                    header: true, 
                    skipEmptyLines: true,
                    dynamicTyping: true
                });

                // Process HMS Warehouse data
                hmsWarehouses = hmsParsed.data.map((row, index) => ({
                    id: row.id || index + 1,
                    zona: (row.zona || row.ZONA || '').trim(),
                    kota: (row.kota || row.KOTA || row.nama || row.NAMA || '').trim(),
                    lat: parseFloat(row.lat || row.LAT || row.latitude || row.LATITUDE || 0),
                    lng: parseFloat(row.lng || row.LNG || row.longitude || row.LONGITUDE || 0)
                })).filter(item => item.lat !== 0 && item.lng !== 0 && item.kota);

                // Process Telkom Office data
                telkomOffices = telkomParsed.data.map((row, index) => ({
                    id: row.id || index + 1,
                    kota: (row.kota || row.KOTA || '').trim(),
                    nama: (row.nama || row.NAMA || row.name || row.NAME || '').trim(),
                    lat: parseFloat(row.lat || row.LAT || row.latitude || row.LATITUDE || 0),
                    lng: parseFloat(row.lng || row.LNG || row.longitude || row.LONGITUDE || 0)
                })).filter(item => item.lat !== 0 && item.lng !== 0 && item.nama);

                console.log('HMS Warehouses loaded:', hmsWarehouses.length);
                console.log('Telkom Offices loaded:', telkomOffices.length);

                return hmsWarehouses.length > 0 && telkomOffices.length > 0;
            } catch (error) {
                console.error('Error loading data from Google Sheets:', error);
                return false;
            }
        }

        // Calculate distance
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Find nearest Telkom office
        function findNearestTelkom(warehouse) {
            let nearest = null;
            let minDistance = Infinity;
            telkomOffices.forEach(telkom => {
                const distance = calculateDistance(warehouse.lat, warehouse.lng, telkom.lat, telkom.lng);
                if (distance < minDistance) {
                    minDistance = distance;
                    nearest = { ...telkom, distance };
                }
            });
            return nearest;
        }

        // Generate all mappings
        function getAllMappings() {
            return hmsWarehouses.map(warehouse => ({
                warehouse,
                nearestTelkom: findNearestTelkom(warehouse)
            }));
        }

        // Export to CSV
        function exportToCSV() {
            const allMappings = getAllMappings();
            const headers = ['No','HMS WAREHOUSE','ZONA HMS','LATITUDE HMS','LONGITUDE HMS','OFFICE TELKOM TERDEKAT','KOTA TELKOM','LATITUDE TELKOM','LONGITUDE TELKOM','JARAK (KM)','STATUS'].join(',');
            const rows = allMappings.map((mapping, idx) => {
                const status = mapping.nearestTelkom.distance <= 20 ? 'Sesuai Kriteria (≤20km)' : 'Lebih dari 20km';
                return [idx + 1, `"${mapping.warehouse.kota}"`, `"${mapping.warehouse.zona}"`, mapping.warehouse.lat.toFixed(6), mapping.warehouse.lng.toFixed(6), `"${mapping.nearestTelkom.nama}"`, `"${mapping.nearestTelkom.kota}"`, mapping.nearestTelkom.lat.toFixed(6), mapping.nearestTelkom.lng.toFixed(6), mapping.nearestTelkom.distance.toFixed(2), `"${status}"`].join(',');
            });
            const under20 = allMappings.filter(m => m.nearestTelkom.distance <= 20).length;
            const over20 = allMappings.filter(m => m.nearestTelkom.distance > 20).length;
            const summary = ['','','RINGKASAN DATA',`Total HMS Warehouse: ${allMappings.length}`,`Jarak ≤ 20 km: ${under20} lokasi`,`Jarak > 20 km: ${over20} lokasi`,`Tanggal Export: ${new Date().toLocaleDateString('id-ID')}`].join('\n');
            const csv = [headers, ...rows, summary].join('\n');
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + csv], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `HMS-Telkom-Mapping-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // State management
        let selectedWarehouse = null;
        let filterZone = 'ALL';
        let currentTab = 'map';
        let map = null;

        function getZones() {
            return ['ALL', ...new Set(hmsWarehouses.map(w => w.zona))];
        }

        // Initialize or update map
        function initMap(warehouse, telkom) {
            if (map) {
                map.remove();
                map = null;
            }

            setTimeout(() => {
                map = L.map('map').setView([warehouse.lat, warehouse.lng], 10);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors'
                }).addTo(map);

                const hmsIcon = L.divIcon({
                    className: 'custom-icon',
                    html: '<div style="background-color: #dc2626; color: white; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; border: 3px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3);"><i class="fas fa-warehouse"></i></div>',
                    iconSize: [36, 36],
                    iconAnchor: [18, 18]
                });

                const telkomIcon = L.divIcon({
                    className: 'custom-icon',
                    html: '<div style="background-color: #2563eb; color: white; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; border: 3px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3);"><i class="fas fa-building"></i></div>',
                    iconSize: [36, 36],
                    iconAnchor: [18, 18]
                });

                L.marker([warehouse.lat, warehouse.lng], { icon: hmsIcon })
                    .bindPopup(`<strong>HMS Warehouse</strong><br>${warehouse.kota}<br><small>${warehouse.zona}</small>`)
                    .addTo(map);

                L.marker([telkom.lat, telkom.lng], { icon: telkomIcon })
                    .bindPopup(`<strong>Telkom Office</strong><br>${telkom.nama}<br><small>${telkom.kota}</small>`)
                    .addTo(map);

                const lineColor = telkom.distance <= 20 ? '#10b981' : '#f59e0b';
                L.polyline([[warehouse.lat, warehouse.lng], [telkom.lat, telkom.lng]], {
                    color: lineColor,
                    weight: 3,
                    opacity: 0.7,
                    dashArray: '10, 10'
                }).addTo(map);

                const bounds = L.latLngBounds([[warehouse.lat, warehouse.lng], [telkom.lat, telkom.lng]]);
                map.fitBounds(bounds, { padding: [50, 50] });
            }, 100);
        }

        // Render app
        function render() {
            const allMappings = getAllMappings();
            const zones = getZones();
            const filteredWarehouses = filterZone === 'ALL' ? hmsWarehouses : hmsWarehouses.filter(w => w.zona === filterZone);
            const filteredMappings = filterZone === 'ALL' ? allMappings : allMappings.filter(m => m.warehouse.zona === filterZone);
            const under20km = allMappings.filter(m => m.nearestTelkom.distance <= 20).length;
            const over20km = allMappings.filter(m => m.nearestTelkom.distance > 20).length;
            const nearestTelkom = selectedWarehouse ? findNearestTelkom(selectedWarehouse) : null;

            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="max-w-7xl mx-auto">
                    <!-- Header -->
                    <div class="bg-white rounded-xl shadow-md p-6 mb-6">
                        <div class="flex items-center gap-3 mb-2">
                            <i class="fas fa-map-marked-alt text-3xl text-indigo-600"></i>
                            <h1 class="text-3xl font-bold text-gray-800">HMS Warehouse - Telkom Office Mapper</h1>
                        </div>
                        <p class="text-gray-600">Analisis jarak antara gudang HMS dengan kantor Telkom terdekat</p>
                        
                        <!-- Statistics -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
                            <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-lg border border-blue-200">
                                <div class="flex items-center gap-3">
                                    <i class="fas fa-warehouse text-2xl text-blue-600"></i>
                                    <div>
                                        <div class="text-2xl font-bold text-blue-700">${hmsWarehouses.length}</div>
                                        <div class="text-sm text-gray-700">Total HMS Warehouse</div>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-gradient-to-br from-green-50 to-green-100 p-4 rounded-lg border border-green-200">
                                <div class="flex items-center gap-3">
                                    <i class="fas fa-check-circle text-2xl text-green-600"></i>
                                    <div>
                                        <div class="text-2xl font-bold text-green-700">${under20km}</div>
                                        <div class="text-sm text-gray-700">Jarak ≤ 20 km</div>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-gradient-to-br from-orange-50 to-orange-100 p-4 rounded-lg border border-orange-200">
                                <div class="flex items-center gap-3">
                                    <i class="fas fa-exclamation-triangle text-2xl text-orange-600"></i>
                                    <div>
                                        <div class="text-2xl font-bold text-orange-700">${over20km}</div>
                                        <div class="text-sm text-gray-700">Jarak > 20 km</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Controls -->
                    <div class="bg-white rounded-xl shadow-md p-4 mb-6">
                        <div class="flex flex-wrap gap-4 items-center justify-between">
                            <div class="flex items-center gap-3">
                                <label class="text-sm font-semibold text-gray-700 flex items-center gap-2">
                                    <i class="fas fa-filter text-indigo-600"></i>
                                    Filter Zona:
                                </label>
                                <select id="zoneFilter" class="border border-gray-300 rounded-lg px-4 py-2 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                    ${zones.map(zone => `<option value="${zone}" ${filterZone === zone ? 'selected' : ''}>${zone}</option>`).join('')}
                                </select>
                            </div>
                            
                            <button onclick="exportToCSV()" class="flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition shadow-sm">
                                <i class="fas fa-download"></i>
                                Export CSV
                            </button>
                        </div>
                    </div>

                    <!-- Tab Navigation -->
                    <div class="bg-white rounded-xl shadow-md mb-6">
                        <div class="flex border-b border-gray-200">
                            <button onclick="switchTab('map')" class="flex-1 px-6 py-4 text-center transition ${currentTab === 'map' ? 'tab-active' : 'tab-inactive hover:text-indigo-500'}">
                                <i class="fas fa-map mr-2"></i>
                                Peta Pemetaan
                            </button>
                            <button onclick="switchTab('table')" class="flex-1 px-6 py-4 text-center transition ${currentTab === 'table' ? 'tab-active' : 'tab-inactive hover:text-indigo-500'}">
                                <i class="fas fa-table mr-2"></i>
                                Tabel Data Lengkap
                            </button>
                        </div>
                    </div>

                    ${currentTab === 'map' ? `
                    <!-- Map View -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Warehouse List -->
                        <div class="lg:col-span-1 bg-white rounded-xl shadow-md p-4 max-h-[700px] overflow-y-auto">
                            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                                <i class="fas fa-warehouse text-red-600"></i>
                                HMS Warehouses (${filteredWarehouses.length})
                            </h2>
                            <div class="space-y-2">
                                ${filteredWarehouses.map(warehouse => {
                                    const nearest = findNearestTelkom(warehouse);
                                    const isNear = nearest.distance <= 20;
                                    return `
                                    <button onclick="selectWarehouse(${warehouse.id})" class="w-full text-left p-3 rounded-lg border-2 transition ${selectedWarehouse?.id === warehouse.id ? 'border-indigo-500 bg-indigo-50 shadow-md' : 'border-gray-200 hover:border-indigo-300 hover:bg-gray-50'}">
                                        <div class="flex justify-between items-start">
                                            <div class="flex-1">
                                                <div class="font-semibold text-gray-800">${warehouse.kota}</div>
                                                <div class="text-xs text-gray-500 mt-1">${warehouse.zona}</div>
                                            </div>
                                            <span class="text-xs px-2 py-1 rounded ${isNear ? 'bg-green-100 text-green-700' : 'bg-orange-100 text-orange-700'}">
                                                ${nearest.distance.toFixed(1)} km
                                            </span>
                                        </div>
                                    </button>
                                `}).join('')}
                            </div>
                        </div>

                        <!-- Details Panel -->
                        <div class="lg:col-span-2">
                            ${selectedWarehouse && nearestTelkom ? `
                                <div class="bg-white rounded-xl shadow-md p-6">
                                    <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                                        <i class="fas fa-route text-indigo-600"></i>
                                        Detail Pemetaan
                                    </h2>
                                    
                                    <!-- Info Cards -->
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
                                        <div class="bg-gradient-to-br from-red-50 to-red-100 p-4 rounded-lg border border-red-200">
                                            <div class="text-center">
                                                <i class="fas fa-warehouse text-3xl text-red-600 mb-2"></i>
                                                <h3 class="font-bold text-sm text-gray-800 mb-1">HMS Warehouse</h3>
                                                <p class="text-gray-800 font-semibold text-sm">${selectedWarehouse.kota}</p>
                                                <p class="text-xs text-gray-600 mt-1">${selectedWarehouse.zona}</p>
                                                <p class="text-xs text-gray-500 mt-2">
                                                    <i class="fas fa-map-pin"></i> ${selectedWarehouse.lat.toFixed(4)}, ${selectedWarehouse.lng.toFixed(4)}
                                                </p>
                                            </div>
                                        </div>

                                        <div class="flex items-center justify-center p-4 rounded-lg ${nearestTelkom.distance <= 20 ? 'bg-gradient-to-br from-green-50 to-green-100 border border-green-300' : 'bg-gradient-to-br from-orange-50 to-orange-100 border border-orange-300'}">
                                            <div class="text-center">
                                                <i class="fas fa-ruler text-2xl ${nearestTelkom.distance <= 20 ? 'text-green-700' : 'text-orange-700'} mb-2"></i>
                                                <div class="text-3xl font-bold ${nearestTelkom.distance <= 20 ? 'text-green-700' : 'text-orange-700'}">
                                                    ${nearestTelkom.distance.toFixed(2)} km
                                                </div>
                                                <div class="text-xs font-semibold ${nearestTelkom.distance <= 20 ? 'text-green-800' : 'text-orange-800'} mt-1">
                                                    ${nearestTelkom.distance <= 20 ? 'Sesuai Kriteria' : 'Melebihi Batas'}
                                                </div>
                                            </div>
                                        </div>

                                        <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-lg border border-blue-200">
                                            <div class="text-center">
                                                <i class="fas fa-building text-3xl text-blue-600 mb-2"></i>
                                                <h3 class="font-bold text-sm text-gray-800 mb-1">Telkom Office</h3>
                                                <p class="text-gray-800 font-semibold text-sm">${nearestTelkom.nama}</p>
                                                <p class="text-xs text-gray-600 mt-1">${nearestTelkom.kota}</p>
                                                <p class="text-xs text-gray-500 mt-2">
                                                    <i class="fas fa-map-pin"></i> ${nearestTelkom.lat.toFixed(4)}, ${nearestTelkom.lng.toFixed(4)}
                                                </p>
                                            </div>
                                        </div>
                                    </div>

                                    <div id="map" class="mb-4"></div>

                                    <a href="https://www.google.com/maps/dir/${selectedWarehouse.lat},${selectedWarehouse.lng}/${nearestTelkom.lat},${nearestTelkom.lng}" target="_blank" class="flex items-center justify-center gap-2 w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition font-semibold shadow-md">
                                        <i class="fas fa-directions"></i>
                                        Lihat Rute di Google Maps
                                    </a>
                                </div>
                            ` : `
                                <div class="bg-white rounded-xl shadow-md p-12 text-center">
                                    <i class="fas fa-mouse-pointer text-6xl text-gray-300 mb-4"></i>
                                    <h3 class="text-xl font-semibold text-gray-600 mb-2">Pilih Warehouse HMS</h3>
                                    <p class="text-gray-500">Pilih salah satu warehouse dari daftar di sebelah kiri untuk melihat peta dan informasi kantor Telkom terdekat</p>
                                </div>
                            `}
                        </div>
                    </div>
                    ` : `
                    <!-- Table View -->
                    <div class="bg-white rounded-xl shadow-md p-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                            <i class="fas fa-table text-indigo-600"></i>
                            Semua Data Pemetaan (${filteredMappings.length})
                        </h2>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-100 border-b-2 border-gray-200">
                                    <tr>
                                        <th class="px-4 py-3 text-left font-semibold text-gray-700">No</th>
                                        <th class="px-4 py-3 text-left font-semibold text-gray-700">HMS Warehouse</th>
                                        <th class="px-4 py-3 text-left font-semibold text-gray-700">Zona</th>
                                        <th class="px-4 py-3 text-left font-semibold text-gray-700">Telkom Office</th>
                                        <th class="px-4 py-3 text-left font-semibold text-gray-700">Kota Telkom</th>
                                        <th class="px-4 py-3 text-right font-semibold text-gray-700">Jarak (km)</th>
                                        <th class="px-4 py-3 text-center font-semibold text-gray-700">Status</th>
                                        <th class="px-4 py-3 text-center font-semibold text-gray-700">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    ${filteredMappings.map((mapping, idx) => `
                                        <tr class="hover:bg-gray-50 transition">
                                            <td class="px-4 py-3 text-gray-600">${idx + 1}</td>
                                            <td class="px-4 py-3 font-medium text-gray-800">${mapping.warehouse.kota}</td>
                                            <td class="px-4 py-3 text-gray-600 text-xs">${mapping.warehouse.zona}</td>
                                            <td class="px-4 py-3 text-gray-700">${mapping.nearestTelkom.nama}</td>
                                            <td class="px-4 py-3 text-gray-600">${mapping.nearestTelkom.kota}</td>
                                            <td class="px-4 py-3 text-right font-semibold text-gray-800">
                                                ${mapping.nearestTelkom.distance.toFixed(2)}
                                            </td>
                                            <td class="px-4 py-3 text-center">
                                                <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-semibold ${
                                                    mapping.nearestTelkom.distance <= 20
                                                        ? 'bg-green-100 text-green-700'
                                                        : 'bg-orange-100 text-orange-700'
                                                }">
                                                    <i class="fas fa-${mapping.nearestTelkom.distance <= 20 ? 'check' : 'exclamation-triangle'}"></i>
                                                    ${mapping.nearestTelkom.distance <= 20 ? '≤ 20km' : '> 20km'}
                                                </span>
                                            </td>
                                            <td class="px-4 py-3 text-center">
                                                <button onclick="viewOnMap(${mapping.warehouse.id})" class="text-indigo-600 hover:text-indigo-800 transition">
                                                    <i class="fas fa-map-marked-alt"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    `}

                    <!-- Footer Info -->
                    <div class="mt-6 bg-white rounded-xl shadow-md p-4">
                        <div class="flex items-center gap-2 text-sm text-gray-600">
                            <i class="fas fa-info-circle text-indigo-600"></i>
                            <span>Data diambil dari Google Sheets dan diperbarui secara real-time</span>
                        </div>
                    </div>
                </div>
            `;

            // Add event listener for zone filter
            const zoneFilter = document.getElementById('zoneFilter');
            if (zoneFilter) {
                zoneFilter.addEventListener('change', (e) => {
                    filterZone = e.target.value;
                    render();
                });
            }

            // Initialize map if warehouse is selected and on map tab
            if (selectedWarehouse && nearestTelkom && currentTab === 'map') {
                initMap(selectedWarehouse, nearestTelkom);
            }
        }

        // Event handlers
        window.selectWarehouse = function(id) {
            selectedWarehouse = hmsWarehouses.find(w => w.id === id);
            render();
        };

        window.switchTab = function(tab) {
            currentTab = tab;
            render();
        };

        window.viewOnMap = function(id) {
            selectedWarehouse = hmsWarehouses.find(w => w.id === id);
            currentTab = 'map';
            render();
        };

        window.exportToCSV = exportToCSV;

        // Initial load and render
        (async function init() {
            // Show loading message
            document.getElementById('app').innerHTML = `
                <div class="max-w-7xl mx-auto">
                    <div class="bg-white rounded-xl shadow-md p-12 text-center">
                        <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-indigo-600 mx-auto mb-4"></div>
                        <h3 class="text-xl font-semibold text-gray-700 mb-2">Memuat Data...</h3>
                        <p class="text-gray-500">Mengambil data dari Google Sheets</p>
                    </div>
                </div>
            `;
            
            // Load data from Google Sheets
            const success = await loadDataFromSheets();
            
            if (success && hmsWarehouses.length > 0 && telkomOffices.length > 0) {
                // Render the app
                render();
            } else {
                document.getElementById('app').innerHTML = `
                    <div class="max-w-7xl mx-auto">
                        <div class="bg-white rounded-xl shadow-md p-12 text-center">
                            <i class="fas fa-exclamation-triangle text-6xl text-red-500 mb-4"></i>
                            <h3 class="text-xl font-semibold text-gray-700 mb-2">Gagal Memuat Data</h3>
                            <p class="text-gray-500 mb-4">Tidak dapat memuat data dari Google Sheets.</p>
                            <button onclick="location.reload()" class="bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 transition">
                                <i class="fas fa-redo mr-2"></i>
                                Coba Lagi
                            </button>
                        </div>
                    </div>
                `;
            }
        })();
    </script>
</body>
</html>

